<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Performance Marketing GPT | PMax Specialist</title>
  <meta name="description" content="AI-powered performance marketing reasoning engine." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    body { font-family: system-ui, sans-serif; }
    .typing::after {
      content: "▋";
      animation: blink 1s infinite;
      margin-left: 2px;
    }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>

<body class="bg-gray-100 dark:bg-slate-900 text-gray-900 dark:text-gray-100">

<!-- Loader -->
<div id="loading" class="h-screen flex items-center justify-center text-sm">
  Initializing Performance Engine…
</div>

<!-- App -->
<div id="app" class="max-w-4xl mx-auto p-4 opacity-0">

  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="font-bold text-lg">Performance Marketing GPT</h1>
    <button onclick="toggleTheme()" class="text-xs opacity-70">Toggle Theme</button>
  </div>

  <!-- Chat -->
  <div id="chat" class="min-h-[300px] mb-4"></div>

  <!-- Input -->
  <textarea id="input"
    class="w-full p-3 rounded-lg border dark:bg-slate-800"
    placeholder="Ask about PMax, ROAS, SEO, CRO, budgets, scaling…"
    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}">
  </textarea>

  <!-- Watermark -->
  <div class="text-center text-xs opacity-40 mt-6">
    Powered by Listan Dsouza
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_ENDPOINT =
  "https://performance-marketing-api.listandsouza.workers.dev";
const MODEL = "openai/gpt-oss-120b";

/* ================= STATE ================= */
const state = {
  messages: [],
  isTyping: false
};

/* ================= INIT ================= */
window.onload = () => {
  marked.setOptions({ breaks: true });
  document.getElementById("loading").remove();
  document.getElementById("app").style.opacity = "1";
};

/* ================= SEND ================= */
async function sendMessage() {
  if (state.isTyping) return;

  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text) return;

  input.value = "";
  state.messages.push({ role: "user", content: text });
  render();

  state.isTyping = true;
  appendThinking();

  try {
    const intent = classifyIntent(text);
    const clarify = autoClarify(text, intent);

    let reply;
    if (clarify) {
      reply = clarify;
    } else {
      reply = await callWorker(state.messages, intent);
    }

    state.messages.push({ role: "assistant", content: reply });
  } catch (e) {
    state.messages.push({
      role: "assistant",
      content: offlineLogic(text)
    });
  }

  state.isTyping = false;
  render();
}

/* ================= WORKER ================= */
async function callWorker(messages, intent) {
  const res = await fetch(WORKER_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: MODEL,
      messages: [
        {
          role: "system",
          content:
            `You are a ${intent} expert. Answer logically, step-by-step, using real-world marketing reasoning.`
        },
        ...messages
      ]
    })
  });

  if (!res.ok) throw new Error("Worker failed");
  const data = await res.json();
  return data.choices[0].message.content;
}

/* ================= INTENT ================= */
function classifyIntent(q) {
  q = q.toLowerCase();
  if (q.includes("pmax")) return "Performance Max";
  if (q.includes("seo")) return "SEO";
  if (q.includes("cro") || q.includes("conversion")) return "CRO";
  return "Marketing Strategy";
}

/* ================= CLARIFY ================= */
function autoClarify(q, intent) {
  if (intent === "Performance Max" && !q.match(/\d|\$/))
    return "Before optimizing PMax, what is your **daily budget and target CPA**?";
  if (intent === "SEO" && !q.includes("site"))
    return "Which **website or niche** are you optimizing for SEO?";
  if (intent === "CRO" && !q.includes("traffic"))
    return "What is your **monthly traffic and current conversion rate**?";
  return null;
}

/* ================= OFFLINE ================= */
function offlineLogic(q) {
  q = q.toLowerCase();
  if (q.includes("roas"))
    return "ROAS drops when traffic quality, offer, or conversion rate breaks. Fix landing page before bids.";
  if (q.includes("budget"))
    return "Daily budget should be 3–5× CPA. Never scale more than 20% per day.";
  if (q.includes("headline"))
    return "High-performing headlines = Outcome + Urgency + Clarity.";
  return "Strong marketing decisions come from correct assumptions, not more spend.";
}

/* ================= UI ================= */
function appendThinking() {
  const chat = document.getElementById("chat");
  chat.innerHTML += `
    <div class="mb-4">
      <div class="inline-block p-3 rounded-lg bg-white dark:bg-slate-800 typing">
        Thinking…
      </div>
    </div>`;
}

function render() {
  const chat = document.getElementById("chat");
  chat.innerHTML = state.messages.map(m => `
    <div class="mb-4 ${m.role === "user" ? "text-right" : ""}">
      <div class="inline-block p-3 rounded-lg bg-white dark:bg-slate-800 prose dark:prose-invert">
        ${marked.parse(m.content)}
      </div>
    </div>
  `).join("");
  chat.scrollTop = chat.scrollHeight;
}

/* ================= THEME ================= */
function toggleTheme() {
  document.documentElement.classList.toggle("dark");
}
</script>

</body>
</html>
